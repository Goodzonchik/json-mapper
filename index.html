<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JSONata test</title>
    <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>

    <style>
      #browsers {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <pre id="browsers"></pre>

    <script>
      (async () => {
        const url = `https://raw.githubusercontent.com/Fyrd/caniuse/refs/heads/main/fulldata-json/data-2.0.json`;

        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();

        const expression = jsonata(
          `(
              $getDate := function($x) {$fromMillis($x * 1000, '[D].[M].[Y]')};

              $getBrowsers := function($z, $x) {(
                $each($z, function($v) {$v[type=$x]}).
                  ({
                      'browser': browser,
                      'currentVersion': current_version,
                      'releaseDate': $getDate(version_list[era=0].release_date),
                      'globalBrowserUsing': $sum(version_list.global_usage) &'%'
                  })
              )};

              {
                'desktop': $getBrowsers(agents, 'desktop'),
                'mobile': $getBrowsers(agents, 'mobile')
              };
            )
        `
        );
        const result = await expression.evaluate(data);

        console.log(result);

        const container = document.getElementById("browsers");
        container.innerText = JSON.stringify(result, null, 2);
      })();
    </script>
  </body>
</html>
